version: '3.8'

services:
  # Servidor DNS Dockerizado
  dns-server:
    build: ./dns
    container_name: dns-server
    ports:
      - "53:53/udp"
      - "53:53/tcp"
    volumes:
      - ./dns/dnsmasq.conf:/etc/dnsmasq.conf:ro
    restart: unless-stopped
    cap_add:
      - NET_ADMIN

  front:
    build:
      context: ./ligador-wifi
      dockerfile: Dockerfile
    image: wifi-frontend
    restart: always
    ports:
      - "4205:4205"
    environment:
      FRONT_ENV: teste

  back:
    build:
      context: ./target/0.0.2
      dockerfile: Dockerfile
    image: wifi-backend:0.0.2-SNAPSHOT
    env_file:
      - .env
    ports:
      - "8085:8085"
    restart: always
    environment:
      - ASTERISK_HOST=asterisk
      - ASTERISK_PORT=45600
    depends_on:
      - asterisk
      - dns-server

  nginx:
    build: ./nginx
    image: wifi-nginx
    ports:
      - "80:80"
      - "443:443"
      - "5173:5173"
    depends_on:
      - front
      - back
      - dns-server
    volumes:
      - /home/tracevia/app/certificates/homologacaotracevia.com.br-0003/:/etc/nginx/certs/:ro
#      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - /home/tracevia/app/applications/docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
#     - /home/tracevia/app/certificates/homologacaotracevia.com.br-0003/:/etc/nginx/certs/:ro
#       - ./nginx/nginx.conf/:/etc/nginx/nginx.conf:ro
#      - ./nginx/conf.d/:/etc/nginx/conf.d/:ro
#      - ./nginx/sites-available/:/etc/nginx/sites-available/:ro
#      - ./nginx/sites-enabled/:/etc/nginx/sites-enabled/:ro
    restart: always

  asterisk:
    image: asterisk/asterisk:18.11.0
    ports:
      - "5060:5060"
      - "5061:5061"
      - "8088:8088"
      - "8089:8089"
      - "5038:5038"
      - "10000-10500:10000-10500"
    volumes:
      #- /home/tracevia/app/certificates/homologacaotracevia.com.br-0003/:/etc/asterisk/keys/
      - ./asterisk/config/:/etc/asterisk/:ro
      - asterisk-data:/var/lib/asterisk
      - asterisk-logs:/var/log/asterisk
      - asterisk-spool:/var/spool/asterisk
    environment:
      - TZ=America/Sao_Paulo
    restart: always

volumes:
  asterisk-data:
  asterisk-logs:
  asterisk-spool:

